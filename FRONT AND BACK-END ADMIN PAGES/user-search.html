<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- CSS FOR THIS PAGE -->
    <link rel="stylesheet" href="../css/users.css">
    <!-- CSS FOR NAVIGATION -->
    <link rel="stylesheet" href="../css/landingstyle.css">
    <!-- ICONS -->
    <script src="https://kit.fontawesome.com/e8889d9a0b.js" crossorigin="anonymous"></script>
    <title>Search Users Page</title>
</head>

<body>
    <!-- RESPONSIVE NAVIGATION LEFT-SIDE BAR FOR SCREENS BELOW 600PX -->
    <div class="responsive-sidenav">
        <a class="big-links" href="index.html"><i class="fas fa-home"></i></a>
        <a class="big-links" href="landing.html"><i class="fas fa-user-lock"></i></a>

        <!-- Users Management -->
        <button class="dropdown-btn"><i class="fas fa-user-alt"></i> <i id="fa" class="fa fa-caret-down"></i></button>
        <div class="dropdown-container">
            <a href="user-add.html"><i class="fas fa-user-plus"></i></a>
            <a href="user-remove.html"><i class="fas fa-user-times"></i></a>
            <a href="user-update.html"><i class="fas fa-user-edit"></i></a>
            <a href="user-search.html"><i class="fas fa-search"></i></a>
        </div>

        <!-- Books Management -->
        <button class="dropdown-btn"><i class="fas fa-book"></i> <i id="fa" class="fa fa-caret-down"></i></button>
        <div class="dropdown-container">
            <a href="book-add.html"><i class="fas fa-plus-square"></i></a>
            <a href="book-delete.html"><i class="fas fa-minus-square"></i></a>
            <a href="book-search.html"><i class="fas fa-search"></i></a>
        </div>

        <!-- Loans Management -->
        <button class="dropdown-btn"><i class="fas fa-user-clock"></i>  <i id="fa" class="fa fa-caret-down"></i></button>
        <div class="dropdown-container">
            <a href="loan-book.html"><i class="fas fa-hourglass-start"></i></a>
            <a href="loan-search.html"><i class="fas fa-search"></i></a>
        </div>

        <!-- Support Information -->
        <button class="dropdown-btn"><i class="fas fa-info-circle"></i></button>
        <div class="dropdown-container">
            <p> Room 3.67<br> 100 Newport Road<br> Cardiff
                <br> CF76 3HI<br> Tel: 029654786<br></p>
        </div>
    </div>

    <!-- NAVIGATION LEFT-SIDE BAR -->
    <div class="sidenav">
        <a class="big-links" href="../index.html">University Website</a>
        <a class="big-links" href="../landing.html">Back to Admin</a>

        <!-- Users Management -->
        <button class="dropdown-btn"><i class="fas fa-user-alt"></i> Users 
                  <i class="fa fa-caret-down"></i>
                </button>
        <div class="dropdown-container">
            <a href="user-add.html"><i class="fas fa-user-plus"></i> Add User</a>
            <a href="user-remove.html"><i class="fas fa-user-times"></i> Remove User</a>
            <a href="user-update.html"><i class="fas fa-user-edit"></i> Update User</a>
            <a href="user-search.html"><i class="fas fa-search"></i> Search Users</a>
        </div>

        <!-- Books Management -->
        <button class="dropdown-btn"><i class="fas fa-book"></i> Books 
                    <i class="fa fa-caret-down"></i>
                  </button>
        <div class="dropdown-container">
            <a href="book-add.html"><i class="fas fa-plus-square"></i> Add Book</a>
            <a href="book-delete.html"><i class="fas fa-minus-square"></i> Delete Book</a>
            <a href="book-search.html"><i class="fas fa-search"></i> Search Books</a>
        </div>

        <!-- Loans Management -->
        <button class="dropdown-btn"><i class="fas fa-user-clock"></i> Loans 
                    <i class="fa fa-caret-down"></i>
                  </button>
        <div class="dropdown-container">
            <a href="loan-book.html"><i class="fas fa-hourglass-start"></i> Loan Book</a>
            <a href="loan-search.html"><i class="fas fa-search"></i> Search Loans</a>
        </div>

        <!-- Support Information -->
        <button class="dropdown-btn"> Contact Support </button>
        <div class="dropdown-container">
            <a href="#"> Room 3.67<br> 100 Newport Road<br> Cardiff
                <br> CF76 3HI<br> Tel: 029654786<br></a>
        </div>
    </div>
    <div class="main">
        <h1>University of PontyBridge Library</h1>
        <h2>Search Users</h2>
        <div class="row">
            <!-- The search user form by barcode starts here  -->
            <div class="first">
                <form role="search" style="padding-top: 5%;">
                    <fieldset>
                        <legend class="legend-edit">Search Existing User by Barcode</legend>
                        <label for="search_term">User Barcode: <input type="text" name="barcode" id="search_term" pattern="[0-9]{6}" title="6 digit barcode" aria-label="enter barcode" aria-required="true" required></label>
                        <input type="button" id="search_button" value="Search">
                    </fieldset>
                </form>
                <div class="bottom-border" style="padding-top: 5%;">Searched Users</div>
                <div id="output"></div>
            </div>


            <!-- The search user by name form starts here -->
            <div class="second">
                <form role="search" style="padding-top: 5%;">
                    <fieldset>
                        <legend class=" legend-edit ">Search Existing User by Name</legend>
                        <label for="search_term ">User Name: <input type="text " name="name " id="search_term " aria-required="true" required></label>
                        <input type="button" id="search_button" value="Search">
                    </fieldset>
                </form>
                <div class="bottom-border" style="padding-top: 5%;">Searched Users</div>
                <div id="output" role="list"></div>
            </div>

        </div>
    </div>

    <!-- JavaScript code starts here -->
    <script>
        /* Loop through all dropdown buttons to toggle between hiding and showing its dropdown content - This allows the user to have multiple dropdowns without any conflict */
        var dropdown = document.getElementsByClassName("dropdown-btn");
        var i;

        for (i = 0; i < dropdown.length; i++) {
            dropdown[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var dropdownContent = this.nextElementSibling;
                if (dropdownContent.style.display === "block") {
                    dropdownContent.style.display = "none";
                } else {
                    dropdownContent.style.display = "block";
                }
            });
        }

        ////////////////////////////
        // SEARCH USER BY BARCODE //
        ////////////////////////////

        const encodeParameters = function(params) {
            // turns JASON data into a string to concatenate to base url
            var strArray = [];
            Object.keys(params).forEach(function(key) {
                var paramString = encodeURIComponent(key) + "=" + encodeURIComponent(params[key]);
                strArray.push(paramString);
            });
            return strArray.join(" & ");
        };

        const processResponse = function() {
            // appends the returned data into the specified html div
            let response = JSON.parse(this.response);
            console.log(response);
            let outputDiv = document.getElementById("output ");
            let newList = createList(outputDiv);
            var i;
            for (i = 0; i < response.length; i++) {
                // loops through the response and adds selected JSON data to html
                addListItem(newList, "ID: " + response[i].id);
                addListItem(newList, "Name: " + response[i].name);
                addListItem(newList, "Barcode: " + response[i].barcode);
                addListItem(newList, "Member Type: " + response[i].memberType);
            }
        };

        const createList = function(parentElement) {
            // creates an empty div
            let newList = document.createElement("div ");
            parentElement.appendChild(newList);
            return newList;
        };
        const addListItem = function(parentList, textContent) {
            // makes paragraphs inside the empty div whch will be filled with returned data
            let newItem = document.createElement("p ");
            newItem.appendChild(document.createTextNode(textContent));
            parentList.appendChild(newItem);
        };

        // GET request
        const makeAPIQuery = function(search_term) {
            // setting base url
            let rootURL = "http://127.0.0.1:3000/search?type=user ";
            // parameters which will be concatenated to the base URL based on input from client
            // making the form search by barcode
            let params = {
                barcode: search_term,
            };

            // creating the full url which returns the barcode address
            let queryURL = rootURL + "& " + encodeParameters(params);
            console.log(queryURL);
            // sending request
            let xhttp = new XMLHttpRequest();
            xhttp.addEventListener("load ", processResponse);
            xhttp.open("GET ", queryURL);
            xhttp.send();

        };
        // making sure the GET request is only submitted when search button is clicked
        let submitButton = document.getElementById("search_button ");
        submitButton.addEventListener("click ", function() {
            if (document.getElementById("search_term ").value === " ") {
                alert("Enter Barcode to Search. ");
                return false;
            } else {
                let search_term = document.getElementById("search_term ").value;
                if (search_term) {
                    makeAPIQuery(search_term);
                }
                return true;
            }
        });

        /////////////////////////
        // SEARCH USER BY NAME //
        /////////////////////////

        /* This interferes with above JS needs to be recoded 

                // Functions prepare code for the GET request 
                const encodeParameters = function(params) {
                    // turns JASON data into a string to concatenate to base url
                    var strArray = [];
                    Object.keys(params).forEach(function(key) {
                        var paramString = encodeURIComponent(key) + "=" + encodeURIComponent(params[key]);
                        strArray.push(paramString);
                    });
                    return strArray.join("&");
                };

                const processResponse = function() {
                    // appends the returned data into the specified html div
                    let response = JSON.parse(this.response);
                    console.log(response);
                    let outputDiv = document.getElementById("output");
                    let newList = createList(outputDiv);
                    var i;
                    for (i = 0; i < response.length; i++) {
                        // loops through the response and adds selected JSON data to html
                        addListItem(newList, "ID: " + response[i].id);
                        addListItem(newList, "Name: " + response[i].name);
                        addListItem(newList, "Barcode: " + response[i].barcode);
                        addListItem(newList, "Member Type: " + response[i].memberType);
                    }
                };

                const createList = function(parentElement) {
                    // creates a new div
                    let newList = document.createElement("div");
                    parentElement.appendChild(newList);
                    return newList;
                };
                const addListItem = function(parentList, textContent) {
                    // creates a new paragraph within the new div for data to be added to 
                    let newItem = document.createElement("p");
                    newItem.appendChild(document.createTextNode(textContent));
                    parentList.appendChild(newItem);
                };

                // GET request
                const makeAPIQuery = function(search_term) {
                    // set base URL which will be used to search for a user
                    let rootURL = "http://127.0.0.1:3000/search?type=user";
                    // parameters which will be concatenated to the base URL based on input from client
                    // making the form search by name
                    let params = {
                        name: search_term
                    }

                    // generating the full URL to send to the server
                    let queryURL = rootURL + "&" + encodeParameters(params);
                    console.log(queryURL);
                    //sending the GET request
                    let xhttp = new XMLHttpRequest();
                    xhttp.addEventListener("load", processResponse);
                    xhttp.open("GET", queryURL);
                    xhttp.send();

                };

                let submitButton = document.getElementById("search_button");
                // creating an event listener to only make the GET request when search button is clicked on
                submitButton.addEventListener("click", function() {
                    // check for empty fields before sending to server
                    if (document.getElementById("search_term").value === "") {
                        alert("Enter Name to Search.");
                        return false;
                    } else {
                        let search_term = document.getElementById("search_term").value;
                        if (search_term) {
                            makeAPIQuery(search_term);
                        }
                        return true;
                    }

                });
                /* User's details are now visible on the web page after searching a user's name,
                the input field accepts all characters to make it easier to search for users
                without knowing exact spelling of someone's name or just to see all users 
                who's name has an "m" or "-" in it for example. */
    </script>
</body>

</html>